# 王者荣耀智能助手 - 部署指南

## 文档信息

| 项目 | 内容 |
|------|------|
| 项目名称 | 王者荣耀智能助手 |
| 文档版本 | v1.0.0 |
| 编写日期 | 2026-02-14 |
| 适用环境 | Windows/Linux |
| 文档状态 | 正式版 |

---

## 1. 部署概述

### 1.1 部署架构

```
前端 (Nginx)     后端 (Gunicorn)     数据库 (MySQL)
     :80/443            :8000              :3306
        ↓                  ↓                  ↓
        └────────────────┴────────────────────┘
                        应用服务器
```

### 1.2 环境要求

#### 服务器要求

| 项目 | 最低配置 | 推荐配置 |
|------|---------|---------|
| CPU | 2核 | 4核及以上 |
| 内存 | 4GB | 8GB及以上 |
| 硬盘 | 50GB | 100GB及以上 |
| 操作系统 | Windows 10+ / Ubuntu 20.04+ | Ubuntu 22.04 LTS |
| Python | 3.13+ | 3.13+ |
| Node.js | 18+ | 20+ |

#### 软件依赖

- Python 3.13+
- Node.js 18+
- MySQL 8.0+ 或 PostgreSQL 14+（生产环境）
- Nginx 1.20+（生产环境）
- Git

---

## 2. 开发环境部署

### 2.1 克隆项目

```bash
git clone https://github.com/yourusername/honor-of-kings-agent.git
cd honor-of-kings-agent
```

### 2.2 后端部署

#### 2.2.1 创建虚拟环境

```bash
cd backend
python -m venv venv
```

#### 2.2.2 激活虚拟环境

**Windows:**
```bash
venv\Scripts\activate
```

**Linux/Mac:**
```bash
source venv/bin/activate
```

#### 2.2.3 安装依赖

```bash
pip install -r requirements.txt
```

#### 2.2.4 配置环境变量

复制`.env.example`为`.env`：

```bash
cp .env.example .env
```

编辑`.env`文件：

```env
DATABASE_URL=sqlite:///honor_of_kings.db
GLM_API_KEY=your_glm_api_key_here
GLM_API_URL=https://open.bigmodel.cn/api/paas/v4/chat/completions
```

#### 2.2.5 初始化数据库

```bash
python -c "from app.core.database import engine; from app.models import user, hero, match; Base.metadata.create_all(bind=engine)"
```

#### 2.2.6 导入数据

导入英雄数据：

```bash
python scripts/import_real_hero_data.py
```

导入示例对局数据：

```bash
python scripts/import_sample_matches.py
```

#### 2.2.7 启动后端服务

```bash
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

访问：http://localhost:8000

---

### 2.3 前端部署

#### 2.3.1 安装依赖

```bash
cd frontend
npm install
```

#### 2.3.2 配置环境变量

编辑`.env.development`：

```env
VITE_API_BASE_URL=http://localhost:8000/api/v1
VITE_APP_TITLE=王者荣耀智能助手
VITE_APP_VERSION=1.0.0
```

#### 2.3.3 启动开发服务器

```bash
npm run dev
```

访问：http://localhost:5173 或 http://localhost:5174

---

### 2.4 快速启动

项目提供了快速启动脚本：

**Windows:**
```bash
START.bat
```

该脚本会自动启动前后端服务。

---

## 3. 生产环境部署

### 3.1 服务器准备

#### 3.1.1 更新系统

```bash
sudo apt update && sudo apt upgrade -y
```

#### 3.1.2 安装必要软件

```bash
sudo apt install -y python3.13 python3-pip nodejs npm nginx mysql-server git
```

#### 3.1.3 配置防火墙

```bash
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

---

### 3.2 数据库配置

#### 3.2.1 安装MySQL

```bash
sudo apt install -y mysql-server
sudo mysql_secure_installation
```

#### 3.2.2 创建数据库

```bash
sudo mysql -u root -p
```

```sql
CREATE DATABASE honor_of_kings CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'hok_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON honor_of_kongs.* TO 'hok_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### 3.2.3 导入表结构

使用Alembic迁移：

```bash
cd backend
alembic upgrade head
```

---

### 3.3 后端部署

#### 3.3.1 部署代码

```bash
cd /var/www
sudo mkdir -p honor-of-kings-agent/backend
sudo chown -R $USER:$USER honor-of-kings-agent
cd honor-of-kings-agent/backend
git clone https://github.com/yourusername/honor-of-kings-agent.git .
```

#### 3.3.2 创建虚拟环境

```bash
python3.13 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
pip install gunicorn
```

#### 3.3.3 配置环境变量

```bash
cp .env.example .env
nano .env
```

编辑`.env`文件：

```env
DATABASE_URL=mysql+pymysql://hok_user:your_password@localhost/honor_of_kings
GLM_API_KEY=your_glm_api_key_here
GLM_API_URL=https://open.bigmodel.cn/api/paas/v4/chat/completions
ENVIRONMENT=production
```

#### 3.3.4 配置Gunicorn

创建`gunicorn_config.py`：

```python
import multiprocessing

bind = "127.0.0.1:8000"
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "uvicorn.workers.UvicornWorker"
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 50
timeout = 30
keepalive = 2
preload_app = True
accesslog = "/var/log/honor-of-kings-agent/access.log"
errorlog = "/var/log/honor-of-kings-agent/error.log"
loglevel = "info"
```

#### 3.3.5 创建Systemd服务

创建`/etc/systemd/system/honor-of-kings-agent.service`：

```ini
[Unit]
Description=Honor of Kings Agent Backend
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/honor-of-kings-agent/backend
Environment="PATH=/var/www/honor-of-kings-agent/backend/venv/bin"
ExecStart=/var/www/honor-of-kings-agent/backend/venv/bin/gunicorn -c gunicorn_config.py app.main:app
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl start honor-of-kings-agent
sudo systemctl enable honor-of-kings-agent
```

---

### 3.4 前端部署

#### 3.4.1 部署代码

```bash
cd /var/www/honor-of-kings-agent/frontend
git clone https://github.com/yourusername/honor-of-kings-agent.git .
```

#### 3.4.2 安装依赖

```bash
npm install
```

#### 3.4.3 构建项目

编辑`.env.production`：

```env
VITE_API_BASE_URL=/api/v1
VITE_APP_TITLE=王者荣耀智能助手
VITE_APP_VERSION=1.0.0
```

构建：

```bash
npm run build
```

#### 3.4.4 配置Nginx

创建Nginx配置文件`/etc/nginx/sites-available/honor-of-kings-agent`：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    root /var/www/honor-of-kings-agent/frontend/dist;
    index index.html;

    # 前端路由
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/honor-of-kings-agent /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

---

### 3.5 SSL证书配置

#### 3.5.1 使用Let's Encrypt

```bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

#### 3.5.2 自动续期

```bash
sudo certbot renew --dry-run
```

Certbot会自动配置续期。

---

## 4. Docker部署（可选）

### 4.1 创建Dockerfile

#### 4.1.1 后端Dockerfile

创建`backend/Dockerfile`：

```dockerfile
FROM python:3.13-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["gunicorn", "-c", "gunicorn_config.py", "app.main:app"]
```

#### 4.1.2 前端Dockerfile

创建`frontend/Dockerfile`：

```dockerfile
FROM node:20-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
```

### 4.2 创建docker-compose.yml

创建`docker-compose.yml`：

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=mysql+pymysql://root:password@db:3306/honor_of_kings
      - GLM_API_KEY=${GLM_API_KEY}
    depends_on:
      - db
    restart: always

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: always

  db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=honor_of_kings
    volumes:
      - mysql_data:/var/lib/mysql
    restart: always

volumes:
  mysql_data:
```

### 4.3 启动容器

```bash
docker-compose up -d
```

---

## 5. 监控与维护

### 5.1 日志管理

#### 5.1.1 查看后端日志

```bash
sudo journalctl -u honor-of-kings-agent -f
```

#### 5.1.2 查看Nginx日志

```bash
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

#### 5.1.3 日志轮转

创建`/etc/logrotate.d/honor-of-kings-agent`：

```
/var/log/honor-of-kings-agent/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload honor-of-kings-agent > /dev/null 2>&1 || true
    endscript
}
```

---

### 5.2 性能监控

#### 5.2.1 系统监控

```bash
# CPU使用率
top

# 内存使用
free -h

# 磁盘使用
df -h

# 网络连接
netstat -tulpn
```

#### 5.2.2 应用监控

使用Prometheus + Grafana监控应用性能。

---

### 5.3 备份策略

#### 5.3.1 数据库备份

创建备份脚本`/var/www/honor-of-kings-agent/scripts/backup.sh`：

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/honor-of-kings-agent"
mkdir -p $BACKUP_DIR

mysqldump -u root -p'your_password' honor_of_kings > $BACKUP_DIR/db_$DATE.sql
gzip $BACKUP_DIR/db_$DATE.sql

find $BACKUP_DIR -name "db_*.sql.gz" -mtime +30 -delete
```

添加到crontab：

```bash
crontab -e
```

```cron
0 2 * * * /var/www/honor-of-kings-agent/scripts/backup.sh
```

---

### 5.4 更新部署

#### 5.4.1 拉取最新代码

```bash
cd /var/www/honor-of-kings-agent
git pull origin main
```

#### 5.4.2 更新后端

```bash
cd backend
source venv/bin/activate
pip install -r requirements.txt
alembic upgrade head
sudo systemctl restart honor-of-kings-agent
```

#### 5.4.3 更新前端

```bash
cd frontend
npm install
npm run build
sudo systemctl reload nginx
```

---

## 6. 故障排查

### 6.1 常见问题

#### 6.1.1 后端无法启动

**检查服务状态：**

```bash
sudo systemctl status honor-of-kings-agent
```

**查看日志：**

```bash
sudo journalctl -u honor-of-kings-agent -n 50
```

**常见原因：**
- 数据库连接失败
- 端口被占用
- 环境变量配置错误

#### 6.1.2 前端无法访问

**检查Nginx状态：**

```bash
sudo systemctl status nginx
```

**查看日志：**

```bash
sudo tail -f /var/log/nginx/error.log
```

**常见原因：**
- Nginx配置错误
- 静态文件路径错误
- 端口被占用

#### 6.1.3 数据库连接失败

**检查MySQL状态：**

```bash
sudo systemctl status mysql
```

**测试连接：**

```bash
mysql -u hok_user -p honor_of_kings
```

**常见原因：**
- 密码错误
- 数据库不存在
- 用户权限不足

---

### 6.2 性能优化

#### 6.2.1 数据库优化

```sql
-- 添加索引
CREATE INDEX idx_matches_user_id ON matches(user_id);
CREATE INDEX idx_matches_hero_id ON matches(hero_id);
```

#### 6.2.2 缓存配置

使用Redis缓存热点数据。

#### 6.2.3 负载均衡

多实例部署，使用Nginx负载均衡。

---

## 7. 安全加固

### 7.1 系统安全

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 配置防火墙
sudo ufw enable

# 禁用root登录
sudo nano /etc/ssh/sshd_config
# 设置 PermitRootLogin no

# 使用SSH密钥认证
```

### 7.2 应用安全

- 使用HTTPS
- 配置CORS
- 启用CSRF保护
- 定期更新依赖
- 设置强密码

### 7.3 数据安全

- 定期备份数据库
- 加密敏感信息
- 限制数据库访问权限

---

## 8. 附录

### 8.1 端口说明

| 服务 | 端口 | 说明 |
|------|------|------|
| Nginx HTTP | 80 | HTTP访问 |
| Nginx HTTPS | 443 | HTTPS访问 |
| 后端API | 8000 | 后端服务 |
| MySQL | 3306 | 数据库 |

### 8.2 目录结构

```
/var/www/honor-of-kings-agent/
├── backend/               # 后端代码
├── frontend/              # 前端代码
├── scripts/               # 脚本文件
└── logs/                  # 日志文件
```

### 8.3 配置文件清单

| 文件 | 路径 | 说明 |
|------|------|------|
| 后端环境变量 | /var/www/honor-of-kings-agent/backend/.env | 后端配置 |
| 前端环境变量 | /var/www/honor-of-kings-agent/frontend/.env.production | 前端配置 |
| Nginx配置 | /etc/nginx/sites-available/honor-of-kings-agent | Nginx配置 |
| Systemd服务 | /etc/systemd/system/honor-of-kings-agent.service | 后端服务 |

---

**文档结束**
